#!/usr/bin/env bash
set -euo pipefail

# Add SSH public key for remote access
# https://github.com/basecamp/omaterm

if gum confirm "Add SSH public key for remote access?"; then
  mkdir -p "$HOME/.ssh"
  chmod 700 "$HOME/.ssh"

  SSH_KEY=$(gum input --placeholder "ssh-ed25519 AAAAC3..." --prompt "SSH key: ")

  if [[ -n $SSH_KEY ]]; then
    echo "$SSH_KEY" >"$HOME/.ssh/authorized_keys"
    chmod 600 "$HOME/.ssh/authorized_keys"
    echo "SSH key added to authorized_keys."

    # Offer to disable password auth if not already disabled
    if ! grep -q "^PasswordAuthentication no" /etc/ssh/sshd_config 2>/dev/null; then
      if gum confirm "Disable password authentication for SSH (key-based auth only)?"; then
        sudo sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config
        sudo sed -i 's/^#*PubkeyAuthentication.*/PubkeyAuthentication yes/' /etc/ssh/sshd_config
        sudo systemctl restart sshd.service
        echo "SSH configured for key-based authentication only."
      fi
    fi
  fi
fi
